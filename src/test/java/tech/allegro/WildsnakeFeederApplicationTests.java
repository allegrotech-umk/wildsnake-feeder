package tech.allegro;

import org.junit.Before;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.springframework.batch.core.ExitStatus;
import org.springframework.batch.core.JobExecution;
import org.springframework.batch.core.StepExecution;
import org.springframework.batch.test.JobLauncherTestUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.SpringApplicationConfiguration;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.test.context.ActiveProfiles;
import org.springframework.test.context.junit4.SpringJUnit4ClassRunner;
import tech.allegro.config.TestTwittItemReader;
import tech.allegro.io.twitter.domain.Twitt;

import static org.hamcrest.MatcherAssert.assertThat;
import static org.hamcrest.core.Is.is;

@RunWith(SpringJUnit4ClassRunner.class)
@SpringApplicationConfiguration(classes = WildsnakeFeederApplication.class)
@ActiveProfiles("test")
public class WildsnakeFeederApplicationTests {
	private static final String deleteSql = "DELETE FROM product";

	@Test
	public void shouldFinishJobSuccessfully() throws Exception{
		//given
		itemStreamReader.addStubTwitt("{\"created_at\":\"Mon Apr 11 06:39:35 +0000 2016\",\"id\":719414577411317760,\"id_str\":\"719414577411317760\",\"text\":\"RT @AJENews: \\\"Zuma is the head of the snake and he has to be removed $50 \\\" https:\\/\\/t.co\\/NfEh8DarRu https:\\/\\/t.co\\/03LhWtprTs\",\"source\":\"\\u003ca href=\\\"http:\\/\\/twitter.com\\/download\\/iphone\\\" rel=\\\"nofollow\\\"\\u003eTwitter for iPhone\\u003c\\/a\\u003e\",\"truncated\":false,\"in_reply_to_status_id\":null,\"in_reply_to_status_id_str\":null,\"in_reply_to_user_id\":null,\"in_reply_to_user_id_str\":null,\"in_reply_to_screen_name\":null,\"user\":{\"id\":322723669,\"id_str\":\"322723669\",\"name\":\"banjo1902\",\"screen_name\":\"ahmedagunrege\",\"location\":\"Lagos state\",\"url\":null,\"description\":\"Electronic consultancy,dstv ,cctv cameras,intercom n home appliances.\",\"protected\":false,\"verified\":false,\"followers_count\":88,\"friends_count\":207,\"listed_count\":4,\"favourites_count\":58,\"statuses_count\":2702,\"created_at\":\"Thu Jun 23 16:56:22 +0000 2011\",\"utc_offset\":null,\"time_zone\":null,\"geo_enabled\":true,\"lang\":\"en\",\"contributors_enabled\":false,\"is_translator\":false,\"profile_background_color\":\"C0DEED\",\"profile_background_image_url\":\"http:\\/\\/abs.twimg.com\\/images\\/themes\\/theme1\\/bg.png\",\"profile_background_image_url_https\":\"https:\\/\\/abs.twimg.com\\/images\\/themes\\/theme1\\/bg.png\",\"profile_background_tile\":false,\"profile_link_color\":\"0084B4\",\"profile_sidebar_border_color\":\"C0DEED\",\"profile_sidebar_fill_color\":\"DDEEF6\",\"profile_text_color\":\"333333\",\"profile_use_background_image\":true,\"profile_image_url\":\"http:\\/\\/pbs.twimg.com\\/profile_images\\/718711709561655296\\/ZbyAE86X_normal.jpg\",\"profile_image_url_https\":\"https:\\/\\/pbs.twimg.com\\/profile_images\\/718711709561655296\\/ZbyAE86X_normal.jpg\",\"profile_banner_url\":\"https:\\/\\/pbs.twimg.com\\/profile_banners\\/322723669\\/1458466993\",\"default_profile\":true,\"default_profile_image\":false,\"following\":null,\"follow_request_sent\":null,\"notifications\":null},\"geo\":null,\"coordinates\":null,\"place\":null,\"contributors\":null,\"retweeted_status\":{\"created_at\":\"Sun Apr 10 23:30:09 +0000 2016\",\"id\":719306506836045824,\"id_str\":\"719306506836045824\",\"text\":\"\\\"Zuma is the head of the snake and he has to be removed\\\" https:\\/\\/t.co\\/NfEh8DarRu https:\\/\\/t.co\\/03LhWtprTs\",\"source\":\"\\u003ca href=\\\"http:\\/\\/www.socialflow.com\\\" rel=\\\"nofollow\\\"\\u003eSocialFlow\\u003c\\/a\\u003e\",\"truncated\":false,\"in_reply_to_status_id\":null,\"in_reply_to_status_id_str\":null,\"in_reply_to_user_id\":null,\"in_reply_to_user_id_str\":null,\"in_reply_to_screen_name\":null,\"user\":{\"id\":18424289,\"id_str\":\"18424289\",\"name\":\"AJE News\",\"screen_name\":\"AJENews\",\"location\":\"Doha, Qatar\",\"url\":\"http:\\/\\/aljazeera.com\",\"description\":\"Follow @AJENews for the latest news, on-going coverage and unique perspectives from around the world. For more: @AJEnglish\",\"protected\":false,\"verified\":true,\"followers_count\":1010635,\"friends_count\":362,\"listed_count\":16066,\"favourites_count\":41,\"statuses_count\":73896,\"created_at\":\"Sun Dec 28 08:02:32 +0000 2008\",\"utc_offset\":3600,\"time_zone\":\"London\",\"geo_enabled\":false,\"lang\":\"en\",\"contributors_enabled\":false,\"is_translator\":false,\"profile_background_color\":\"FFFFFF\",\"profile_background_image_url\":\"http:\\/\\/pbs.twimg.com\\/profile_background_images\\/433511991982821376\\/ZwClzpaF.jpeg\",\"profile_background_image_url_https\":\"https:\\/\\/pbs.twimg.com\\/profile_background_images\\/433511991982821376\\/ZwClzpaF.jpeg\",\"profile_background_tile\":false,\"profile_link_color\":\"CB922A\",\"profile_sidebar_border_color\":\"FFFFFF\",\"profile_sidebar_fill_color\":\"E4E2E2\",\"profile_text_color\":\"333333\",\"profile_use_background_image\":false,\"profile_image_url\":\"http:\\/\\/pbs.twimg.com\\/profile_images\\/448478250503647233\\/xZOjTaoA_normal.jpeg\",\"profile_image_url_https\":\"https:\\/\\/pbs.twimg.com\\/profile_images\\/448478250503647233\\/xZOjTaoA_normal.jpeg\",\"profile_banner_url\":\"https:\\/\\/pbs.twimg.com\\/profile_banners\\/18424289\\/1459415874\",\"default_profile\":false,\"default_profile_image\":false,\"following\":null,\"follow_request_sent\":null,\"notifications\":null},\"geo\":null,\"coordinates\":null,\"place\":null,\"contributors\":null,\"is_quote_status\":false,\"retweet_count\":46,\"favorite_count\":18,\"entities                                                                                              \":{\"hashtags\":[],\"urls\":[{\"url\":\"https:\\/\\/t.co\\/NfEh8DarRu\",\"expanded_url\":\"http:\\/\\/aje.io\\/b7du\",\"display_url\":\"aje.io\\/b7du\",\"indices\":[57,80]}],\"user_mentions\":[],\"symbols\":[],\"media\":[{\"id\":719306505971974144,\"id_str\":\"719306505971974144\",\"indices\":[81,104],\"media_url\":\"http:\\/\\/pbs.twimg.com\\/media\\/Cft9dMUWQAANpyg.jpg\",\"media_url_https\":\"https:\\/\\/pbs.twimg.com\\/media\\/Cft9dMUWQAANpyg.jpg\",\"url\":\"https:\\/\\/t.co\\/03LhWtprTs\",\"display_url\":\"pic.twitter.com\\/03LhWtprTs\",\"expanded_url\":\"http:\\/\\/twitter.com\\/AJENews\\/status\\/719306506836045824\\/photo\\/1\",\"type\":\"photo\",\"sizes\":{\"small\":{\"w\":340,\"h\":191,\"resize\":\"fit\"},\"medium\":{\"w\":600,\"h\":338,\"resize\":\"fit\"},\"thumb\":{\"w\":150,\"h\":150,\"resize\":\"crop\"},\"large\":{\"w\":800,\"h\":450,\"resize\":\"fit\"}}}]},\"extended_entities\":{\"media\":[{\"id\":719306505971974144,\"id_str\":\"719306505971974144\",\"indices\":[81,104],\"media_url\":\"http:\\/\\/pbs.twimg.com\\/media\\/Cft9dMUWQAANpyg.jpg\",\"media_url_https\":\"https:\\/\\/pbs.twimg.com\\/media\\/Cft9dMUWQAANpyg.jpg\",\"url\":\"https:\\/\\/t.co\\/03LhWtprTs\",\"display_url\":\"pic.twitter.com\\/03LhWtprTs\",\"expanded_url\":\"http:\\/\\/twitter.com\\/AJENews\\/status\\/719306506836045824\\/photo\\/1\",\"type\":\"photo\",\"sizes\":{\"small\":{\"w\":340,\"h\":191,\"resize\":\"fit\"},\"medium\":{\"w\":600,\"h\":338,\"resize\":\"fit\"},\"thumb\":{\"w\":150,\"h\":150,\"resize\":\"crop\"},\"large\":{\"w\":800,\"h\":450,\"resize\":\"fit\"}}}]},\"favorited\":false,\"retweeted\":false,\"possibly_sensitive\":false,\"filter_level\":\"low\",\"lang\":\"en\"},\"is_quote_status\":false,\"retweet_count\":0,\"favorite_count\":0,\"entities\":{\"hashtags\":[],\"urls\":[{\"url\":\"https:\\/\\/t.co\\/NfEh8DarRu\",\"expanded_url\":\"http:\\/\\/aje.io\\/b7du\",\"display_url\":\"aje.io\\/b7du\",\"indices\":[70,93]}],\"user_mentions\":[{\"screen_name\":\"AJENews\",\"name\":\"AJE News\",\"id\":18424289,\"id_str\":\"18424289\",\"indices\":[3,11]}],\"symbols\":[],\"media\":[{\"id\":719306505971974144,\"id_str\":\"719306505971974144\",\"indices\":[94,117],\"media_url\":\"http:\\/\\/pbs.twimg.com\\/media\\/Cft9dMUWQAANpyg.jpg\",\"media_url_https\":\"https:\\/\\/pbs.twimg.com\\/media\\/Cft9dMUWQAANpyg.jpg\",\"url\":\"https:\\/\\/t.co\\/03LhW                                                                                              tprTs\",\"display_url\":\"pic.twitter.com\\/03LhWtprTs\",\"expanded_url\":\"http:\\/\\/twitter.com\\/AJENews\\/status\\/719306506836045824\\/photo\\/1\",\"type\":\"photo\",\"sizes\":{\"small\":{\"w\":340,\"h\":191,\"resize\":\"fit\"},\"medium\":{\"w\":600,\"h\":338,\"resize\":\"fit\"},\"thumb\":{\"w\":150,\"h\":150,\"resize\":\"crop\"},\"large\":{\"w\":800,\"h\":450,\"resize\":\"fit\"}},\"source_status_id\":719306506836045824,\"source_status_id_str\":\"719306506836045824\",\"source_user_id\":18424289,\"source_user_id_str\":\"18424289\"}]},\"extended_entities\":{\"media\":[{\"id\":719306505971974144,\"id_str\":\"719306505971974144\",\"indices\":[94,117],\"media_url\":\"http:\\/\\/pbs.twimg.com\\/media\\/Cft9dMUWQAANpyg.jpg\",\"media_url_https\":\"https:\\/\\/pbs.twimg.com\\/media\\/Cft9dMUWQAANpyg.jpg\",\"url\":\"https:\\/\\/t.co\\/03LhWtprTs\",\"display_url\":\"pic.twitter.com\\/03LhWtprTs\",\"expanded_url\":\"http:\\/\\/twitter.com\\/AJENews\\/status\\/719306506836045824\\/photo\\/1\",\"type\":\"photo\",\"sizes\":{\"small\":{\"w\":340,\"h\":191,\"resize\":\"fit\"},\"medium\":{\"w\":600,\"h\":338,\"resize\":\"fit\"},\"thumb\":{\"w\":150,\"h\":150,\"resize\":\"crop\"},\"large\":{\"w\":800,\"h\":450,\"resize\":\"fit\"}},\"source_status_id\":719306506836045824,\"source_status_id_str\":\"719306506836045824\",\"source_user_id\":18424289,\"source_user_id_str\":\"18424289\"}]},\"favorited\":false,\"retweeted\":false,\"possibly_sensitive\":false,\"filter_level\":\"low\",\"lang\":\"en\",\"timestamp_ms\":\"1460356775988\"}");
		itemStreamReader.addStubTwitt("{\"created_at\":\"Wed Mar 23 08:10:06 +0000 2016\",\"id\":712551986713989120,\"id_str\":\"712551986713989120\",\"text\":\"Dj Snake \\ud83d\\ude28\\ud83d\\ude35 https:\\/\\/t.co\\/UEWzHcntLC\",\"source\":\"\\u003ca href=\\\"http:\\/\\/twitter.com\\/download\\/iphone\\\" rel=\\\"nofollow\\\"\\u003eTwitter for iPhone\\u003c\\/a\\u003e\",\"truncated\":false,\"in_reply_to_status_id\":null,\"in_reply_to_status_id_str\":null,\"in_reply_to_user_id\":null,\"in_reply_to_user_id_str\":null,\"in_reply_to_screen_name\":null,\"user\":{\"id\":2327021581,\"id_str\":\"2327021581\",\"name\":\"Rave Life\",\"screen_name\":\"WeRave\",\"location\":\"Wherever The Music Is\",\"url\":null,\"description\":\"Bringing you everything EDM and Music Festivals! |For business inquires email raleybusiness@gmail.com\",\"protected\":false,\"verified\":false,\"followers_count\":96639,\"friends_count\":5555,\"listed_count\":82,\"favourites_count\":79,\"statuses_count\":3983,\"created_at\":\"Tue Feb 04 12:13:35 +0000 2014\",\"utc_offset\":-14400,\"time_zone\":\"Eastern Time (US & Canada)\",\"geo_enabled\":true,\"lang\":\"en\",\"contributors_enabled\":false,\"is_translator\":false,\"profile_background_color\":\"FFFFFF\",\"profile_background_image_url\":\"http:\\/\\/pbs.twimg.com\\/profile_background_images\\/491165220450996225\\/iHIjBSP2.png\",\"profile_background_image_url_https\":\"https:\\/\\/pbs.twimg.com\\/profile_background_images\\/491165220450996225\\/iHIjBSP2.png\",\"profile_background_tile\":false,\"profile_link_color\":\"373737\",\"profile_sidebar_border_color\":\"FFFFFF\",\"profile_sidebar_fill_color\":\"DDEEF6\",\"profile_text_color\":\"333333\",\"profile_use_background_image\":true,\"profile_image_url\":\"http:\\/\\/pbs.twimg.com\\/profile_images\\/701981250823651328\\/XGjj7znr_normal.jpg\",\"profile_image_url_https\":\"https:\\/\\/pbs.twimg.com\\/profile_images\\/701981250823651328\\/XGjj7znr_normal.jpg\",\"profile_banner_url\":\"https:\\/\\/pbs.twimg.com\\/profile_banners\\/2327021581\\/1456204976\",\"default_profile\":false,\"default_profile_image\":false,\"following\":null,\"follow_request_sent\":null,\"notifications\":null},\"geo\":null,\"coordinates\":null,\"place\":null,\"contributors\":null,\"is_quote_status\":false,\"retweet_count\":259,\"favorite_count\":469,\"entities\":{\"hashtags\":[],\"urls\":[{\"url\":\"https:\\/\\/t.co\\/UEWzHcntLC\",\"expanded_url\":\"https:\\/\\/vine.co\\/v\\/idrH1edOOrU\",\"display_url\":\"vine.co\\/v\\/idrH1edOOrU\",\"indices\":[12,35]}],\"user_mentions\":[],\"symbols\":[]},\"favorited\":false,\"retweeted\":false,\"possibly_sensitive\":false,\"filter_level\":\"low\",\"lang\":\"en\"},\"is_quote_status\":false,\"retweet_count\":0,\"favorite_count\":0,\"entities\":{\"hashtags\":[],\"urls\":[{\"url\":\"https:\\/\\/t.co\\/UEWzHcntLC\",\"expanded_url\":\"https:\\/\\/vine.co\\/v\\/idrH1edOOrU\",\"display_url\":\"vine.co\\/v\\/idrH1edOOrU\",\"indices\":[24,47]}],\"user_mentions\":[{\"screen_name\":\"WeRave\",\"name\":\"Rave Life\",\"id\":2327021581,\"id_str\":\"2327021581\",\"indices\":[3,10]}],\"symbols\":[]},\"favorited\":false,\"retweeted\":false,\"possibly_sensitive\":false,\"filter_level\":\"low\",\"lang\":\"en\",\"timestamp_ms\":\"1460356774805\"}");


		//when
		JobExecution jobExecution = jobLauncherTestUtils.launchJob();
		StepExecution firstStepExecution = jobExecution.getStepExecutions().iterator().next();

		//then
		assertThat("job execution status", jobExecution.getExitStatus(), is(ExitStatus.COMPLETED));
	}

	@Before
	public void setup() {
		jdbcTemplate.update(deleteSql);
	}

	@Autowired
	JobLauncherTestUtils jobLauncherTestUtils;

	@Autowired
	JdbcTemplate jdbcTemplate;

	@Autowired
	TestTwittItemReader itemStreamReader;
}
